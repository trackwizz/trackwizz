sudo: false
services:
- docker
addons:
  apt:
    packages:
    - pass
    - gnupg2
env:
  global:
  - REGISTRY_URL=registry.heroku.com
  - HEROKU_APP_FRONT=trackwizz
  - HEROKU_APP_BACK=trackwizz-api
  - DOCKER_REPO_FRONT=trackwizz/web
  - DOCKER_REPO_BACK=trackwizz-api/web
  - BUILD_BACKEND=trackwizz-api.herokuapp.com
  - secure: elG3r35kyXuPdSFlce6MrXtxy9ZQTWBlWNNO0/6pMakUPV75FoCr2d2nGwBsBjul0ZxpCzPUDAVDc2lgVoibDxcWfONpgSHnfZidkcAkmRkohSs3teZQtuDSMXfhFdrM91G1LyxOLA4YQ0IxcaISO+/a3NKCdZFLqS2bbsYMohM4+zUTiX8urqTSaMnSuRKcWgk1jQams5xE0dFNG/ZYp5gzI/oYMijA9CpN7zhi2cPY9tkb5QaasJc7Dnx37DrNeNEWhKQIzj6pq94pVfgxvoSwTmFyfAUQKEh87h+AR/EfoQv2wIgZgaExEIKwX4o8qn2PnqKV1uspFzPr9LNSKg2f+tElfEcbfL4tiVbBP2HBiv4CfovHtLBFojjJwXmAaAM9XvAo9fFRSzOm5dak4Stbjleixu4zJc9YSGoYLCoe0UYnAd/80YZR2Pj48Qt7GXta8GExhvQGImAuzUUOvNJ7o6QP0hSXvU+Pu0S8YUzpSD+AiPoomhdpNNybP3A0BubXrO7p84Io8hgROoiye67Rf3aJ95A2jIE9OM96DWpw59lmK4W3lANcqv99oGz2MEK4272nBeSjt9RvkWCIyPivaeI+EVjUhdyN9FLydDpE6vmwKitiA0yS1Gsb2J/i9w6UtDeXPJOd0CMDJlIE1jwhITA9+bGMmmZhNv9rxN8=
  - secure: 2e65G0Jyb/fgOYxCNB/hxiZS3Hnrbjtl7N4GQVInLBFo/x8aM1WjJaA/5Zs/tbFiKwc36PAYvhq/TmoZTrLIbRXfmDJeeO/4mY5N5vvpeba6TpsbFrZoyAmCB3tP8+dRjdEk+J75ZqRwiYWNM8ctCysDBLhlbixmmZDp8pxoj4qQL6neuQr8c1+pisflziJZld/VfboDk9x08cIbzxy5ldnDq37W3O9VhlwCWetI4Nt1KTA67YnrS2eZCXtbgbVfBiyOAAK/YrYHXIQksbRicKJtDg9hZAvq5S30uqEpjbcS7UwIMj1a18G675VR915ubqD6JxmazLzxFtA5xS4ZCWeqROvRbf+Fixi0sJv3PxDtIQT6QVpfCoCnwCStE0Odp1NGhb19X4MgFcTXG7BFo+UH1bCm5acludwYySWsUPTVLz3TVOsqI6I2aqrXE8L4In1D+/8zPwTiSgpzOaVX8+jRfiTLo/Ge7sShVIMcYCSAseumN8M5ekmddSkygBKhl5CU+jBhtDpQUZyZoCnEuu24pw6eLgfxRsd8hAes5P9YUCBhgrNZ+/hGCgN3KhDLKrrfuEYW8qmU2R5O84bF1h8ZhLLK1mQjtIWzdjK4MRZHJmgww4uLZFsdNrcJ34IODFScdlhg+L3GLbDzePDCQGu6CzkxftqLwltpP8CvwJw=
  - secure: vT/EgCIRWlUCa+Fao8RI/zQOQS5YctaBVgHY7+gY5Pggkf65D8R1b+4klaX/eqHWyQLm4zVUN4gGDz1rjcJjOAlZBo+7VWb+qPXbBsB4OMRo/Tmn73HCs+OU6KEf4LSDPocyf+DvxvuwLluWIEbTSsYqDqQajrzSId3N9QCnp+ibNdZ42fPF3pUQc/o9Eisy6yfIHvRI9aYaDDKBos5uUedwaUnNEV5P0Gi+BvbyR4iZx2T8w5nLt80iWriC50NonBvb14Gkl+9whIBSC3mszdRhFpNTutAkul5Q7yrO9MGTaTCMkj23G+yIWjG08jfYkbs86f7dJgaeZ1HuTeeG1MJRnw4WTcU6CoL17SSGTOQnlRnaOgYtBkjbleM/K1yf+JqcDVRjwzS/OA63W2o85aqjFeDKgp2oPTlGnvVfxlGUzs0PBiamfbD2Yzez8LVQ8ji704dr4H67+PTojW5ZZEEebxOzNXq9cpJMRNSBUEqIlx/fUhCqbJhzBnWM9hfqQHxy+nLeeR/kPhIQoTUCNMWSKPt1Rvxd6BZXvLiTnQgLhsz8K69ZXMlDLI1+V+mjzyxjsjRMufp+mRN74yrQkzE/ichj3MrRvxb9urr2dpTD4nQrSNSHEkBIdzm2y4VMGKWnGYJcDiShgv4BSrcxHltqeRBdf0qXciTh7ovVbf0=
  - secure: l3qzYuoFfD1ii6akkFRGHziIppg+61SwwfRzfaO/NRKm8CahSpFUmsW2opbEqNoQXcKT1wE+F2mrn/a4n+kp6b8Xz0CF30khv23jccY95WbZXI1eoKVTij+g42qpy4LaAERNAP8m8FbQYweRV7CDhEiM9XYHPCv46sQpCDNcKb0OD4Er4KrbEwllJbR4hCfSX9HYAenwHSEv8xhbtFAxV25tGr/ad/YzNeHjtGQytdjCuQlHjet2ajKg8BIvBPfl5un4E/yZLyf5xM9GeDx+yYnzQ9mh9Hk7fXDJgejGauQWAgqJVuu3o4+ab/YJW29DTDYnzIWtNsVLpQVrDUMx0oRvEc1ge2dPl1HbFhxamChVT4FLq0pb8D7mJNpUa9iFes54Q3Bgqc6dzI2BAf1/vcEGeWahgFmsPaXCG6kQtwQGE886iMCwPRFdGdE6pDeT/Y9WR4DkvCBqoA/C9mNGIQb5JyhHPtdVxPPxp+eMO+Wb2gskOLeyLHZBzIs63rGJwJBKYRO1BoryeglmHLJ7hsNFQLoy26b+Ge1es51BpCu8jMrFaG/C/nYM6qEh7eTgiKS4ij8gFSrdWVJ6X3iv30uOU9mDozymqOhfJfUik65M8lTIBuAZlk6zS/Micg2mgssWScD89lnVlkjnSYAlu9tyzkB0QL+9uhS5uO+RlzA=
  - secure: AhImzMOTohenNuzMdr1PSafLDjkrQILDipPa7ZmnobWJ4r6xhTMIk9vsVa8nMkKYebOig9zoTT4tyluiMaQ/8pqacu4Fe3AYVgHfIFxj0fkdytATkNGKnip8QtfpcjWBVOBybN/MFM4Pe04Ht8dpwdocj0eYGGzbWeTsfLOqAvLcqqxSnk+OF3x17h1vb8MxCdu4IJAgeVG3NeBdkHAANA3+mSH+xeOIeN9F3JMoIooX+xN5ZivA47cn1Sqjl8KWfjgM+WXooyTBxT1DOogIIIqUkKaMPHbSHlQMi5kC8idA6cx+aCWjDDFu5sgeKdCkCVVoZaWuTkSdYNk9FV+Op2/yrPkNfUxOWvvmPtYgoBHs4n1VuABewu/qErCmv09+ztUdVBRXvT4Ur9rVYd8SFQpiUkaPCP33pLaM0/a9HppDtYpQDR+aV6jPwpEo5qIlfyxbbRwhV5CsszYuQZSBdQuh7MGI/vlBtu6MuE4yYDgA3+f5SYVepj0MlWZ7+uMHi+si1JOLhS/B9O9SOv5TUwH0F7viDDcilAKl8Tp2/S+ddU5XaxB/02WIYSa024EkBnPPnGURx/byH5xN7v7PrGdSX+Y5Fic56YuUe5GKfhaztz4T1ypMo8EPvHAGeMH/9pCWvhrBh4j+Unjq2Z+E6yKNfbr19BvcCdv3gzy2388=
  - secure: SkeY+Jx0Qamd1GdPgXRBa50u0T+MzVo+XscgMLdVR/9t0Rg534k0u4Pj4DS4GTmZCR2Ca7EXUKBRKwSQNsG7tXw+z04XczmNKoaET5rn6vP3eGCJfIZhOlZK2CoE+roaWeHuElencIkdDqc9Qcv0WK0XHeZUdwOD8qYc3p0/k0QazbcX4daVEdt7/Uc4o8Xl8qV+MFyslIzvLgGax0JcgYd/KGvWYw+xK6Bmy7eJRQxZlOAVoKFBo64Z7qTUhh4DgR19PnIxM3j+YxePd6vvjujSBKrpJun+6ldQsd+g2k1q12Eoy7kYi7g2lHapo/bHitfO5HlzPkJy7rbb7sj/psA1A+UitUgftRr1/CYpfkiuh5h8RfOf6PzklOOnkn6uzTEqhgrlKyLTwAlfYbfrmCrvgECj25FFHh3FOXd7Jz5aW3/61+plq48xyUHnIu09U3kjHlBzJ6LzgssGMG1mlsib7hOHgxbwZvnhICNGCb32PhqSy0i9Liwf6v6oN7L+x3KWHsf73aYwBB8lM3Ojktht/ONgF0KohZv9rnNWE5UDyiHMFfbmQJ3HpgdYJ1zvYX0GadecDM2pNpPs+VH952ui9a4rdfhCw4ZytP3mGfMBMzbsX32cnZLoP5bJfGXolXBXjMUKdy9wE1KYWMzTCwTlbHX46qeaGX3ipqqxS2A=
  - secure: gjL7IYlzZZn6BPwlU/7tFxda9hj7Fuq/ND9QDY94E3U7CGeFqbO6Kn7dy+cKpLzyFAxWfGU8CFZIgWFPXpBVx9i6khX1LibP/WpgI4RbeyYq1Yl+3+97nuc4+guBtE7DdYUe6ae/qdsKimKlTGYyuIKI34w1/7y3sN8PZ5RPsOI94+9d3AuKT4ROWvuwq0gAqad0OtgjhIBk6mJfqMFG3IvUe8+IMqrZS6OsHCp0gC2PfhQ3/jXWf/AttHc/SmY7zyEjDkgOZxDbh7gLKP8TqIIhtpn0qDxes2fYSf6uytMfNmuUabpUh6omLI9UCNH7LZhTxAQQKBH71yS/pjuLyL6kNL9Iu0ns87HvpPNjPDgxanGnaIKLvfdV+f2EEcTdSHXVw+kqXYBSMNVLhMf9HvkxQgmYyeHm9ayhoSWj5m5LNznb799okxAPWVvo070ZetmIFQjAqhmB5Sq5vfZeWtu6efGwmozuoRAQYe2Wi9FDgHZ7QK3IpQJ6WBuxVXkQnqyS3Ps6FTNxy7vLG046KXboJrDt6rMiotJJO9oLglxl83KhDIrPhg12dqtM+5+saExJmcfmnUmValBoUkl6CpA3W5/DrjG0ogivZ/L8HftaXgt0VP1qQ5QyWnQt1MBGCjiAPbPhTOT9ZEKtGnc0YVXpYpWlJf1O2+a28ez2eUE=
  - secure: cYnlvHo7DNDj7C+hZAL9xkHN/j57rflMiE0iwx3S8gbElOkh6L9EKC2yEPa7mluoH/ZePgnF8SWlK1X7HSojnnoQgWcYLniHx+qvGcHgpFU4f/OEsHhSemK4bF+CitppNvncHZL+4rCjtiQ83yZnZCDcWOm54W89z3QUMZZPcfFe1+7St7Bb8I0lttKKZ76dE1+aVbIHaui7tO0mcJiLodF0Ryc1xGE70Lh+7xCA9Wx6XT9N2cdNezKdzsLm8T4Qf97hGL0Zy+XKcnOEIlcZsx5xYJB3NrThjSPKjLK9reNG1n8vUHa+q0dIoYCSU2ppbep2mO9yLtYrGhokveMf43E29cMsbFwv2hDkFHYFwN/R7Nn3sTD6dMkB6NABOGnrD/VL6SqlXoYt7fEDTVT74WLy/H3agGAjduxw3VSdqHCwQSvFrZ9NnJAZrf5dXDqtA2flAmFlCkkFTcS8SqrmruFmvz88/MS4jJpt1qDcocEF4JknL0dKbKfmq4WP+i8RavtEOIfFmsSSemv5wkOMVzSbVzZ9PTR5qfdT6u9xJxl8oHVlKZtgComy/GVEtX3hGJ38rCPVd9dQTrlYgPzEVr2JmovEAnKypMvE3qgCdMpTqpD+sYCLErLSyKVown8YjSLjqzIlPdZT2g1m82+LGtbuYEkXNmo2xODOd5/CghA=
  - secure: o7WFW7S2Ce0fB7Sda7zx0xmjamK+/NM40ZFCIbMqkaRT0wGtYOCsZWVlBfcPThI+QIj2XRVu1XsItqfCZm+fO6zCvy1cTXCMwUAlMPRM8UINAHEvbqM8eYXtFV8rOkhFJOUG3+h+r5fLB1w82hIOgD+CKkFOjj29V4it/kILit8O8IkNaRkGFgPCB6Tce0ymSgn9uuogEmyLIzXDRQtz38EFwlzi+bLgM/feVrt3agASMziyByE2d9ZIkkMxKycudwP9sjoyYN5XYIC+GForKrunWbbXiZOrCwey1hKKEyjDf04K5GZPuhod47zNRLZ3dejgf53AGmjamh7SJPMaEfUeB7wTJ/EnEdGJnadT3SlPgAIpqkI12XkiIgav+CF+gIf0xqHPTOJx1BYPQ7rUEoZ6yiaF0kz4KTVTBzf20m3u75QDvvz5khx0pVYS3ejFSjok0kDK1UKK7YAG5cgEfDT9aoYxeTxtJN+k2j3b4WTXt/Q1fafo01UlcWQ73FGumQWRemk4wMGxQVV6dbBZL/ujZoSI4Ixjp1KBSIBJE6EmNzSMpX3qrR7rdIVQ5Tt08ilB3yR1uozwCeX7X3LJjVavwodODdAGhJQ145OxthfOaxsFcPO4D7ea5ecV4WbeSaPSq883rH8g7ly0r7Hl46f1NaNnFYkS6XCbE+tXGMI=
  - secure: NOME5h561/n5I5ZNrHTo7sB3xsmMGDL60rP1lMpaFrlqFMI+yEHml0ZiAAbVoegl59JPfIfSwaQ/1lZEQ1Omud8NQ0bWYbRpU+hJxXasIMstWml0K2lO87GSPS8gftCTUP3dFSXpM5MPEoERNi8lKQqt8TaXGBayTQpsSQmewPIZtK98X4mRHCvMpKHF33xOdwHoWzwfIoyD22g6ntntkmImae4c6BoOhGaIt/yp4UJV5cKrBTi4Q5GUT9IpDap8OVEo+jNLIff9yg7mY66KdHGTrOs6Y9scSoqKijPhic4IhtIklSZ2nzPwGC4NZlWIt49ZMxuO2OfnJH5XMbVtkYlDzLw4/I6RwNG6GkCa5stG6KKv9aUGRcDJ2Gm5jKb26xZz6+SlUgVeQtZPFg/3+eq5SR8LJItPG+iLMWZp5w0QqHF3A8BpTrgLRLHe4oXYfV4pZCgq1qoy6IU+l88wW2YdiK9y5ArT6D0vzCiF5KhvzztkYDe3QPQCqgT3mfgULom5fyj3Vm1/3hEh7aWmB5OyGed3J8vY9X4yNomby08cPlff1AczUHvk160FKrHAtjbWgm5Awnz0kOnFCNp3Cu0YcFbXeiaGCimpsQTmaoAuaMG5fII/w6NweCmvMRrZKWv0TkWyPt7R4qn7b2+0Eo8tJJlgBi4+2rEF+VzcQ8M=
  - secure: tEJ6vC466VDvywlZ5dcCinInIjeITMU0Dm5lOdhW0WP9dwcfkoxhowSCNg0Rx5rGntIK3+k0xbHL2KZ/kWFB2aYMDCx3YYgx5upU+P4tucnPnjL3OmZaW21GpOge4epknMJ/M+ChOvp4Ucx9h0PuxuTcuaF1hma6q9yubMdO3526M00cdrePlAVEEO4Fu6TQKdIZFxhmy5eltCxotbUtnqZzuuC48WXwflaEJvE6Vk646sy/Vajwul4MLGThUZnX1KB7BdgDIsCw5QzXyrjtb8N1awcX9f6EvYrqmXYcJ9y8J8nY5JKIz9gUPwCvlr9MMcH17fNy1DKK2ukt8xhvgXmoOpkrN/NCl+o7dpTb2qlw0JD7uYBHdgJcQa9Hepfg4W9e3bAIVZ6L8Rvm7POXvtsu5/o/XecoasH6nGtTCV69vSw3O2AreEaEa9lCFjf4kjbs9ph2hOo4AR1anvwBKcMM/TwSEogCb+D8EcbaUwnka7ZOdmPDhm1Q6Oi3uDo0h0AitAy8PBITs/nD/8A//Jrz8exRNCaZBvzOBiARFyBTOWGgTjdv1f0IcoOHL4P1LjlLKy1QI8XLNguvNdMGh38Qsd7saNgDlFFApWgnGkhcxAtftj3HNeCZy7gIOvtu0/wvlLZUxUzs4V0JlDhPQuPXnpHy2TnQuJAafqJlt0U=
  - secure: iDzN6v6oyiPHX4n1SGfk9tKyPQXey/3XH3slOzgCfyWpsc8eCKPDW5VtFQOYDD86bp4tPgttcrM06c0NbCo7a6NS8LGC/OaQiIE8kRU3ywlirXTwjdFs4Bw/NjErycThYVryw+NXHnteY9NTJfW1Gfy5pJx6/VvSHxaBsJWaYQU1sd901ovyvOKfId0QVnRJZsYx/GSzw1hkCklXU5/sDxDmmH/y7xrns+MbvWZMaNog8khGjXA0GBQCeW2jMhubrvXaWrvOsrlWiqD10w8fgKsrNY6I41gu95nrel2boi6R4pKnLB5XfclW/CKq1P4GjGsW0xHQvfsSYWTkzzuE+PlpHgoW3eibHZ1y5ke6QT/SP5VdF/FBeJZ4c+sZg5ZANX0O+6g6NGeXigCGpTbtS6gV6zhSYoKk89EokhLLuDRU6Z1QDg710S/2VnU7M9B/Z+4VbrppI2VVJdaoFwhvZMh0BAzx8Upbra1VNMxqBL+q+GT+nbzFNVVIDnnPgJ9DevIrWScYRDZqCbIhFyvPWQCqkz1QxBd0I5636EOmMT3ncOo1s4N5p+7JKBNsc96w7IrVherVwR1UeX4AM+HxJw00QkAGLeT7bI02ucaron603RXNkfXqPUITOfV0K4qBna6UU+8jhr35H1J8lANi/7E5xFujfEUga0J5AJgzrMk=
script:
- echo "Skipping tests"
stages:
- test
- name: deploy
  if: branch = master
- name: release
  if: branch = master
jobs:
  include:
  - stage: test
    name: Test
    before_install:
    - docker load -i docker_images/trackwizz-test.tar || true
    before_script:
    - docker-compose -f docker-compose.yml -f docker-compose.test.yml build
    script:
    - docker-compose -f docker-compose.yml -f docker-compose.test.yml run backend
    before_cache:
    - docker save -o docker_images/trackwizz-test.tar $(docker images -a -q)
  - stage: deploy
    name: Deploy
    before_install:
      - docker load -i docker_images/trackwizz-deploy.tar || true
    deploy:
      provider: script
      script: bash scripts/deploy.sh
    after_deploy:
      - docker save -o docker_images/trackwizz-deploy.tar $(docker images -a -q)
  - stage: release
    name: Release backend
    deploy:
      provider: script
      script: bash scripts/heroku_release.sh $HEROKU_APP_BACK
  - stage: release
    name: Release frontend
    deploy:
      provider: script
      script: bash scripts/heroku_release.sh $HEROKU_APP_FRONT
cache:
  directories:
  - docker_images